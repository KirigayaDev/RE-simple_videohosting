<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Видео Хостинг</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #000; color: white; }
        .video-player {
            width: 100%; max-width: 1200px; margin: 2rem auto;
            background: #111; border-radius: 12px; overflow: hidden;
        }
        #mainVideo { width: 100%; height: 60vh; background: #000; }
        .video-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem; max-width: 1200px; margin: 2rem auto;
        }
        .video-thumb {
            background: #222; border-radius: 8px; overflow: hidden; cursor: pointer;
            transition: transform 0.2s;
        }
        .video-thumb:hover { transform: scale(1.02); }
        .video-thumb video { width: 100%; height: 160px; object-fit: cover; }
        .video-info { padding: 1rem; }
        .status { padding: 1rem; text-align: center; margin: 1rem auto; max-width: 500px; }
        .loading { color: #0f0; }
        .error { color: #f44; }
        .controls { padding: 1rem; background: #222; text-align: center; }

        /* Input для UUID */
        .uuid-input {
            background: #333; border: 2px solid #666; border-radius: 8px;
            padding: 1rem; margin: 1rem auto; max-width: 400px; display: block;
            color: white; font-size: 1.1rem; width: 100%;
        }
        .uuid-input:focus { border-color: #0f0; outline: none; }
        .play-btn {
            background: #0f0; color: #000; border: none; padding: 0.8rem 2rem;
            border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 1rem;
        }
        .play-btn:hover { background: #0c0; }
    </style>
</head>
<body>
    <!-- ✅ УБРАНА загрузка видео -->

    <div id="status" class="status" style="display: none;"></div>

    <!-- Input для UUID -->
    <div style="text-align: center; max-width: 600px; margin: 2rem auto;">
        <input
            type="text"
            id="uuidInput"
            class="uuid-input"
            placeholder="Вставьте UUID видео (например: 68452fb4-dad5-4020-a18a-ac0f3b9db680)"
        >
        <button onclick="playByUuid()" class="play-btn">▶️ Проиграть</button>
    </div>

    <!-- HLS PLAYER -->
    <div class="video-player">
        <video id="mainVideo" controls playsinline muted>
            Ваш браузер не поддерживает HLS видео
        </video>
        <div class="controls">
            <span id="currentVideoInfo">Вставьте UUID видео или выберите из списка</span>
        </div>
    </div>

    <div id="videoGrid" class="video-grid"></div>

    <script>
        const API_BASE = '/api';
        const STATUS = document.getElementById('status');
        const VIDEO_GRID = document.getElementById('videoGrid');
        const MAIN_VIDEO = document.getElementById('mainVideo');
        const VIDEO_INFO = document.getElementById('currentVideoInfo');
        const UUID_INPUT = document.getElementById('uuidInput');
        let hls = null;

        // Очистка HLS
        function destroyHls() {
            if (hls) { hls.destroy(); hls = null; }
            MAIN_VIDEO.pause(); MAIN_VIDEO.src = ''; MAIN_VIDEO.load();
        }

        // HLS Player
        function playHls(url, uuid = '') {
            destroyHls();
            VIDEO_INFO.textContent = `Играет: ${uuid.slice(0,8)}... (${url})`;

            if (MAIN_VIDEO.canPlayType('application/vnd.apple.mpegurl')) {
                MAIN_VIDEO.src = url; MAIN_VIDEO.play(); return;
            }

            if (Hls.isSupported()) {
                hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                hls.loadSource(url); hls.attachMedia(MAIN_VIDEO);
                hls.on(Hls.Events.MANIFEST_PARSED, () => MAIN_VIDEO.play());
            }
        }

        // Проигрывание по UUID
        function playByUuid() {
            const uuid = UUID_INPUT.value.trim();
            if (!uuid) {
                alert('Введите UUID видео!');
                return;
            }

            const hlsUrl = `https://localhost:9000/re-simple-videohosting/videos/${uuid}/master.m3u8`;
            playHls(hlsUrl, uuid);
            UUID_INPUT.value = '';
        }

        // Enter в input
        UUID_INPUT.addEventListener('keypress', e => {
            if (e.key === 'Enter') playByUuid();
        });

        async function loadVideos() {
            try {
                const res = await fetch(`${API_BASE}/videos`);
                const videos = await res.json();
                VIDEO_GRID.innerHTML = videos.map(v => `
                    <div class="video-thumb" onclick="playHls('${v.hls_url}', '${v.uuid}');">
                        <video muted loop playsinline>
                            <source src="${v.hls_url}" type="application/x-mpegURL">
                        </video>
                        <div class="video-info">
                            <strong>${v.uuid.slice(0,8)}</strong>
                            <br>${new Date(v.created).toLocaleString('ru')}
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        // HLS.js
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
        script.onload = () => { loadVideos(); setInterval(loadVideos, 10000); };
        document.head.appendChild(script);
    </script>
</body>
</html>
